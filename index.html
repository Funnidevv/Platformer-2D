<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OvO Parkour</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      overflow: hidden;
      font-family: sans-serif;
    }
    canvas {
      display: block;
      background: #222;
    }
    #editorUI {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 10px;
      display: none;
    }
    #editorUI button {
      margin: 4px;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="editorUI">
    <button onclick="setMode('platform')">Platform</button>
    <button onclick="setMode('spike')">Spike</button>
    <button onclick="setMode('goal')">Goal</button>
    <button onclick="saveLevel()">Export Level</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let gameMode = "play";
    let editMode = "platform";

    const keys = {};
    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);

    class Player {
      constructor(x, y) {
        this.startX = x;
        this.startY = y;
        this.reset();
        this.width = 30;
        this.height = 30;
        this.speed = 4;
        this.jumpForce = -12;
        this.grounded = false;
      }

      reset() {
        this.x = this.startX;
        this.y = this.startY;
        this.velX = 0;
        this.velY = 0;
      }

      update() {
        if (keys["ArrowLeft"]) this.velX = -this.speed;
        else if (keys["ArrowRight"]) this.velX = this.speed;
        else this.velX = 0;

        this.velY += 0.6; // gravity

        if (keys["ArrowUp"] && this.grounded) {
          this.velY = this.jumpForce;
          this.grounded = false;
        }

        this.x += this.velX;
        this.y += this.velY;

        this.grounded = false;
        for (let plat of level.platforms) {
          if (this.x < plat.x + plat.width &&
              this.x + this.width > plat.x &&
              this.y + this.height < plat.y + 10 &&
              this.y + this.height + this.velY >= plat.y) {
            this.y = plat.y - this.height;
            this.velY = 0;
            this.grounded = true;
          }
        }

        for (let spike of level.spikes) {
          if (this.x < spike.x + spike.width &&
              this.x + this.width > spike.x &&
              this.y < spike.y + spike.height &&
              this.y + this.height > spike.y) {
            this.reset();
          }
        }

        if (this.x < level.goal.x + level.goal.width &&
            this.x + this.width > level.goal.x &&
            this.y < level.goal.y + level.goal.height &&
            this.y + this.height > level.goal.y) {
          alert("Level Complete!");
          saveProgress();
          this.reset();
        }
      }

      draw() {
        ctx.fillStyle = "#0ff";
        ctx.fillRect(this.x, this.y, this.width, this.height);
      }
    }

    function drawPlatform(p) {
      ctx.fillStyle = "#888";
      ctx.fillRect(p.x, p.y, p.width, p.height);
    }

    function drawSpike(s) {
      ctx.fillStyle = "red";
      ctx.fillRect(s.x, s.y, s.width, s.height);
    }

    function drawGoal(g) {
      ctx.fillStyle = "lime";
      ctx.fillRect(g.x, g.y, g.width, g.height);
    }

    let level = loadLevel();
    const player = new Player(level.spawn.x, level.spawn.y);

    function loadLevel() {
      const saved = localStorage.getItem("customLevel");
      if (saved) return JSON.parse(saved);
      return {
        spawn: { x: 50, y: 50 },
        goal: { x: 700, y: canvas.height - 90, width: 30, height: 30 },
        platforms: [
          { x: 0, y: canvas.height - 40, width: canvas.width, height: 40 },
          { x: 200, y: canvas.height - 120, width: 100, height: 20 }
        ],
        spikes: [
          { x: 400, y: canvas.height - 40, width: 40, height: 40 }
        ]
      };
    }

    function saveProgress() {
      localStorage.setItem("levelComplete", true);
    }

    function saveLevel() {
      localStorage.setItem("customLevel", JSON.stringify(level));
      alert("Level saved to localStorage!");
    }

    function setMode(mode) {
      editMode = mode;
    }

    canvas.addEventListener("click", e => {
      if (gameMode !== "edit") return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (editMode === "platform")
        level.platforms.push({ x, y, width: 100, height: 20 });
      else if (editMode === "spike")
        level.spikes.push({ x, y, width: 30, height: 30 });
      else if (editMode === "goal")
        level.goal = { x, y, width: 30, height: 30 };
    });

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (gameMode === "play") {
        player.update();
        player.draw();
      }
      level.platforms.forEach(drawPlatform);
      level.spikes.forEach(drawSpike);
      drawGoal(level.goal);
      requestAnimationFrame(gameLoop);
    }

    gameLoop();

    if (location.hash === "#editor") {
      gameMode = "edit";
      document.getElementById("editorUI").style.display = "block";
    }
  </script>
</body>
</html>
